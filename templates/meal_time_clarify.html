{% extends "base.html" %}

{% block title %}Meal Time Clarification{% endblock %}

{% block messages %}
<div class="message user">
    <div class="message-bubble">{{ original_sentence }}</div>
</div>

<div class="message bot info">
    {% if icon %}
    <span class="message-icon">{{ icon }}</span>
    {% endif %}
    <div class="message-bubble">
        <h3 style="margin: 0 0 10px;">{{ title }}</h3>
        <p>{{ error_message }}</p>
        
        {% if meals_to_avoid %}
        <div class="event-details">
            <strong>üïê You mentioned avoiding:</strong><br>
            {% for meal in meals_to_avoid %}
            ‚Ä¢ {{ meal }}<br>
            {% endfor %}
        </div>
        {% endif %}
        
        {% if meal_options %}
        <div class="examples-section">
            <h4>üí° Choose a time (before or after meal time):</h4>
            <div class="quick-time-options" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                {% for option in meal_options %}
                <button type="button" 
                        class="quick-action-btn meal-option" 
                        style="background: #f0f0f0; color: #333; border: 1px solid #ccc; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;"
                        onclick="selectMealTime('{{ option.time }}')">
                    {{ option.label }}
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="examples-section">
            <h4>üìù Or specify a clear time:</h4>
            <ul>
                <li><code>tomorrow at 10:00 AM</code></li>
                <li><code>next Monday at 2:30 PM</code></li>
                <li><code>Friday at 11:00 AM</code></li>
                <li><code>this afternoon at 4:00 PM</code></li>
            </ul>
        </div>
        
        <div style="margin-top: 15px;">
            <form action="/nlp_create" method="POST" style="display: flex; gap: 10px;">
                <input type="text" id="meal_time_input" name="sentence" placeholder="Enter a clear time..." style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;" value="{{ original_sentence }}">
                <button type="submit" class="quick-action-btn" style="background: #4285f4; color: white; border: none;">Send</button>
                {% if drive_file_id %}
                <input type="hidden" name="drive_file_id" value="{{ drive_file_id }}">
                <input type="hidden" name="drive_file_name" value="{{ drive_file_name }}">
                <input type="hidden" name="drive_file_url" value="{{ drive_file_url }}">
                {% endif %}
            </form>
        </div>
        
        <div class="quick-actions">
            <button class="quick-action-btn" onclick="window.location.href='/'">üè† Start Over</button>
        </div>
    </div>
</div>

<script>
function selectMealTime(time) {
    var input = document.getElementById('meal_time_input');
    var original = '{{ original_sentence }}';
    
    // Replace "avoid breakfast time" or similar with the selected time
    var newSentence = original.replace(/\bavoid\s+(?:the\s+)?(?:breakfast|lunch|dinner|brunch|snack)\s*(?:time)?\b/gi, '')
                              .replace(/\b(no|not|skip)\s+(?:the\s+)?(?:breakfast|lunch|dinner|brunch|snack)\b/gi, '')
                              .replace(/\b(?:during|at)\s+(?:noon|lunchtime|dinnertime|breakfast\s*time)\b/gi, '')
                              .replace(/\boutside\s+(?:of\s+)?(?:breakfast|lunch|dinner)\s*(?:time)?\b/gi, '')
                              .replace(/\b(?:before|after)\s+(?:breakfast|lunch|dinner)\b/gi, '')
                              .replace(/\b(?:not|never)\s+(?:at\s+)?(?:breakfast|lunch|dinner)\b/gi, '')
                              .replace(/\bavoid\s+meal\s*(?:time)?\b/gi, '')
                              .replace(/\bschedule\s+(?:around|outside)\s+(?:the\s+)?meals?\b/gi, '')
                              .trim();
    
    // Add the selected time
    newSentence = newSentence + ' at ' + time;
    
    // Clean up any extra spaces
    newSentence = newSentence.replace(/\s+/g, ' ').trim();
    
    input.value = newSentence;
    input.focus();
}
</script>
{% endblock %}
